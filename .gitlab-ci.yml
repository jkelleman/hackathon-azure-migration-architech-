# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  .gitlab-ci.yml â€” PushToBicep Architect Agent Pipeline
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# This pipeline triggers when .tf or Dockerfile changes are
# pushed, runs the Duo AI prompt, and opens a Merge Request
# with generated Azure Bicep templates + cost estimate.
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

stages:
  - detect
  - generate
  - publish

variables:
  MIGRATION_BRANCH: "migrate-to-azure"
  PYTHON_IMAGE: "python:3.12-slim"

# â”€â”€ Only run when infra files change â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
.infra_changes:
  rules:
    - changes:
        - "**/*.tf"
        - "**/Dockerfile"
        - "**/Dockerfile.*"
      when: always
    - when: never

# â”€â”€ Stage 1: Detect changed infrastructure files â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
detect_infra:
  stage: detect
  image: alpine:3.19
  extends: .infra_changes
  script:
    - apk add --no-cache git
    - echo "Detecting infrastructure file changes\u2026"
    #
    # CI_COMMIT_BEFORE_SHA is all zeros on the first push to a new
    # branch.  Fall back to diffing against the default branch.
    #
    - |
      BEFORE_SHA="$CI_COMMIT_BEFORE_SHA"
      if [ "$BEFORE_SHA" = "0000000000000000000000000000000000000000" ] || [ -z "$BEFORE_SHA" ]; then
        BEFORE_SHA="origin/$CI_DEFAULT_BRANCH"
      fi
      git diff --name-only "$BEFORE_SHA" "$CI_COMMIT_SHA" \
        | grep -E '\.(tf)$|Dockerfile' \
        | tee /tmp/changed_infra_files.txt || true
    - echo "CHANGED_FILES=$(cat /tmp/changed_infra_files.txt | tr '\n' ',')" >> detect.env
  artifacts:
    reports:
      dotenv: detect.env

# â”€â”€ Stage 2: Run GitLab Duo Agent prompt & generate Bicep â”€â”€â”€â”€
generate_bicep:
  stage: generate
  image: $PYTHON_IMAGE
  extends: .infra_changes
  needs: ["detect_infra"]
  script:
    - echo "Changed files âœ $CHANGED_FILES"
    #
    # Invoke the GitLab Duo Chat API with the PushToBicep Architect
    # prompt template.  The script reads each changed
    # file, builds the prompt, calls Duo, and writes:
    #   generated/main.bicep           â€” the Azure Bicep template
    #   generated/migration_summary.md â€” tables for the MR body
    #   generated/duo_response_raw.md  â€” full AI response (debug)
    #
    - python scripts/invoke_duo_agent.py --files "$CHANGED_FILES" --outdir generated/
    - echo "Generated files:" && ls -la generated/
  artifacts:
    paths:
      - generated/

# â”€â”€ Stage 3: Create branch + commit + open Merge Request â”€â”€â”€â”€â”€
publish_mr:
  stage: publish
  image: $PYTHON_IMAGE
  extends: .infra_changes
  needs: ["generate_bicep"]
  script:
    - echo "Publishing migration Merge Requestâ€¦"
    #
    # 1. Create branch
    #
    - python scripts/open_migration_mr.py --action create-branch
    #
    # 2. Commit generated Bicep file(s)
    #    Pass the file path instead of inlining content via $(cat)
    #    to avoid shell expansion issues with large or special-char files.
    #
    - |
      for bicep in generated/*.bicep; do
        python scripts/open_migration_mr.py \
          --action commit \
          --file "infra/$(basename $bicep)" \
          --content-file "$bicep"
      done
    #
    # 3. Open the Merge Request (use AI-generated summary if available)
    #
    - |
      if [ -f generated/migration_summary.md ]; then
        MR_BODY=$(cat generated/migration_summary.md)
      else
        MR_BODY="## PushToBicep Architect â€” Automated MR

      This MR was created automatically by the GitLab Duo
      **PushToBicep Architect** agent.

      ### What changed
      - Detected infrastructure files: ${CHANGED_FILES}
      - Generated Azure Bicep templates in \`infra/\`"
      fi

      python scripts/open_migration_mr.py \
        --action open-mr \
        --title "ğŸ—ï¸ Azure Migration: auto-generated Bicep templates" \
        --description "${MR_BODY}

      ---
      ### Next steps
      1. Review the generated \`.bicep\` files
      2. Verify the cost estimate table
      3. Run \`az deployment group create\` to validate
      4. Merge when ready ğŸš€"
